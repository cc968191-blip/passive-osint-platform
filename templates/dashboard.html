<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passive OSINT Platform</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Courier New', 'Consolas', monospace;
            background: #000;
            color: #fff;
            min-height: 100vh;
        }

        /* --- NAV --- */
        nav {
            border-bottom: 1px solid #333;
            padding: 0 32px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: .85rem;
        }
        .nav-brand { font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }
        .nav-right { display: flex; gap: 20px; color: #888; font-size: .8rem; }
        .nav-right .dot { display:inline-block; width:6px; height:6px; background:#fff; border-radius:50%; margin-right:6px; }

        /* --- LAYOUT --- */
        .wrap { max-width: 1100px; margin: 0 auto; padding: 40px 24px; }

        /* --- PHASE: INPUT --- */
        #phase-input {}
        .hero { text-align:center; margin-bottom:40px; }
        .hero h1 { font-size:1.6rem; font-weight:bold; letter-spacing:3px; text-transform:uppercase; margin-bottom:8px; }
        .hero p { color:#888; font-size:.85rem; }
        .input-box {
            border: 1px solid #444;
            padding: 32px;
            max-width: 580px;
            margin: 0 auto;
        }
        .field-label {
            display:block; font-size:.75rem; text-transform:uppercase;
            letter-spacing:1px; color:#888; margin-bottom:8px;
        }
        .domain-input {
            width:100%; background:#000; border:1px solid #555; color:#fff;
            padding:12px 14px; font-family:'Courier New',monospace; font-size:.95rem;
        }
        .domain-input:focus { outline:none; border-color:#fff; }
        .modules-grid {
            display:grid; grid-template-columns:1fr 1fr; gap:6px;
            margin:20px 0 28px;
        }
        .mod-item {
            display:flex; align-items:center; gap:8px;
            padding:8px 10px; border:1px solid #333; font-size:.82rem; cursor:pointer;
        }
        .mod-item:hover { border-color:#888; }
        .mod-item input { accent-color:#fff; width:14px; height:14px; cursor:pointer; }
        .mod-item label { cursor:pointer; flex:1; }
        .btn {
            width:100%; padding:14px; background:#fff; color:#000;
            border:none; font-family:'Courier New',monospace; font-size:.85rem;
            font-weight:bold; letter-spacing:1px; text-transform:uppercase; cursor:pointer;
        }
        .btn:hover { background:#ccc; }
        .btn:disabled { opacity:.4; cursor:not-allowed; }
        .btn-outline {
            padding:10px 24px; background:#000; color:#fff;
            border:1px solid #fff; font-family:'Courier New',monospace;
            font-size:.8rem; letter-spacing:1px; text-transform:uppercase; cursor:pointer;
        }
        .btn-outline:hover { background:#fff; color:#000; }

        /* --- PHASE: SCANNING --- */
        #phase-scan { display:none; text-align:center; padding:80px 0; }
        .spinner {
            width:48px; height:48px; border:2px solid #333; border-top-color:#fff;
            border-radius:50%; animation:spin .7s linear infinite; margin:0 auto 24px;
        }
        @keyframes spin { to { transform:rotate(360deg); } }
        #phase-scan h2 { font-size:1.1rem; font-weight:normal; letter-spacing:2px; text-transform:uppercase; margin-bottom:6px; }
        #scan-target { font-weight:bold; }
        #scan-timer {
            margin-top:20px; font-size:1.8rem; font-weight:bold; color:#888; letter-spacing:2px;
        }
        .steps { margin-top:28px; display:inline-flex; flex-direction:column; gap:5px; text-align:left; font-size:.8rem; color:#555; }
        .steps .done { color:#fff; }
        .steps .active { color:#aaa; }

        /* --- PHASE: RESULTS --- */
        #phase-results { display:none; }
        .res-header {
            display:flex; align-items:center; justify-content:space-between;
            border-bottom:1px solid #333; padding-bottom:16px; margin-bottom:24px;
        }
        .res-header h2 { font-size:1rem; font-weight:bold; letter-spacing:2px; text-transform:uppercase; }
        .res-meta { font-size:.78rem; color:#888; margin-top:4px; letter-spacing:.5px; }
        .res-grid { display:flex; flex-direction:column; gap:16px; }

        /* Cards */
        .card { border:1px solid #333; }
        .card-head {
            display:flex; align-items:center; justify-content:space-between;
            padding:12px 16px; border-bottom:1px solid #333; background:#0a0a0a;
        }
        .card-head-title { font-size:.82rem; font-weight:bold; letter-spacing:1px; text-transform:uppercase; }
        .badge {
            font-size:.65rem; padding:2px 8px; border:1px solid #555;
            letter-spacing:.5px; text-transform:uppercase;
        }
        .badge-ok { border-color:#fff; color:#fff; }
        .badge-empty { color:#555; }
        .badge-fail { color:#888; }
        .badge-key { color:#666; }
        .card-body { padding:14px 16px; }

        /* Data list */
        .dlist { list-style:none; max-height:300px; overflow-y:auto; }
        .dlist li {
            padding:6px 0; border-bottom:1px solid #1a1a1a;
            font-size:.8rem; word-break:break-all;
        }
        .dlist li:last-child { border-bottom:none; }
        .dlist-footer { font-size:.72rem; color:#555; padding-top:8px; text-align:right; border-top:1px solid #222; margin-top:8px; }

        /* Key-value */
        .kv { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #1a1a1a; font-size:.82rem; }
        .kv:last-child { border-bottom:none; }
        .kv-k { color:#888; }
        .kv-v { font-weight:bold; }

        .no-data { text-align:center; padding:20px; color:#555; font-size:.82rem; }

        /* --- TOKEN MODAL --- */
        .overlay {
            position:fixed; inset:0; background:rgba(0,0,0,.85);
            display:flex; align-items:center; justify-content:center; z-index:100;
        }
        .overlay.hidden { display:none; }
        .modal { border:1px solid #444; padding:32px; width:400px; max-width:90vw; background:#000; }
        .modal h3 { font-size:.95rem; letter-spacing:1px; text-transform:uppercase; margin-bottom:8px; }
        .modal p { font-size:.8rem; color:#888; margin-bottom:16px; line-height:1.5; }
        .modal input {
            width:100%; background:#000; border:1px solid #555; color:#fff;
            padding:10px; font-family:'Courier New',monospace; font-size:.85rem; margin-bottom:16px;
        }
        .modal input:focus { outline:none; border-color:#fff; }

        /* --- FOOTER --- */
        footer {
            text-align:center; padding:32px 0 16px; font-size:.7rem;
            color:#555; border-top:1px solid #222; margin-top:48px; letter-spacing:.5px;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width:4px; }
        ::-webkit-scrollbar-track { background:#000; }
        ::-webkit-scrollbar-thumb { background:#333; }

        @media (max-width:640px) {
            .modules-grid { grid-template-columns:1fr; }
            nav { padding:0 16px; }
            .wrap { padding:24px 16px; }
            .res-header { flex-direction:column; align-items:flex-start; gap:12px; }
        }
    </style>
</head>
<body>

<nav>
    <div class="nav-brand">Passive OSINT Platform</div>
    <div class="nav-right">
        <span><span class="dot"></span>Online</span>
        <span id="clock"></span>
    </div>
</nav>

<div class="wrap">

    <!-- PHASE 1: INPUT -->
    <div id="phase-input">
        <div class="hero">
            <h1>Reconnaissance</h1>
            <p>Passive intelligence collection from public data sources.</p>
        </div>
        <div class="input-box">
            <form id="recon-form">
                <label class="field-label">Target Domain</label>
                <input type="text" id="domain" class="domain-input" placeholder="example.com" required autocomplete="off" spellcheck="false">

                <label class="field-label" style="margin-top:20px;">Modules</label>
                <div class="modules-grid">
                    <div class="mod-item"><input type="checkbox" id="m-sub" name="modules" value="subdomains" checked><label for="m-sub">Subdomains</label></div>
                    <div class="mod-item"><input type="checkbox" id="m-port" name="modules" value="ports" checked><label for="m-port">Ports</label></div>
                    <div class="mod-item"><input type="checkbox" id="m-tech" name="modules" value="technologies" checked><label for="m-tech">Technologies</label></div>
                    <div class="mod-item"><input type="checkbox" id="m-vuln" name="modules" value="vulnerabilities" checked><label for="m-vuln">Vulnerabilities</label></div>
                    <div class="mod-item"><input type="checkbox" id="m-cred" name="modules" value="credentials" checked><label for="m-cred">Credentials</label></div>
                </div>

                <button type="submit" class="btn" id="submit-btn">Execute Reconnaissance</button>
            </form>
        </div>
    </div>

    <!-- PHASE 2: SCANNING -->
    <div id="phase-scan">
        <div class="spinner"></div>
        <h2>Scanning <span id="scan-target"></span></h2>
        <p style="color:#666;font-size:.82rem;">Collecting intelligence from public sources</p>
        <div id="scan-timer">00:00</div>
        <div class="steps" id="steps">
            <div class="active">Validating domain...</div>
            <div>Resolving DNS...</div>
            <div>Querying crt.sh (Certificate Transparency)...</div>
            <div>Querying Wayback Machine...</div>
            <div>Processing results...</div>
        </div>
    </div>

    <!-- PHASE 3: RESULTS -->
    <div id="phase-results">
        <div class="res-header">
            <div>
                <h2 id="res-title">Results</h2>
                <div class="res-meta" id="res-meta"></div>
            </div>
            <button class="btn-outline" id="btn-new">New Scan</button>
        </div>
        <div class="res-grid" id="res-grid"></div>
    </div>

</div>

<footer>Passive OSINT Platform v1.0.0 &mdash; Authorized passive reconnaissance only &mdash; MIT License</footer>

<!-- TOKEN MODAL -->
<div class="overlay hidden" id="token-overlay">
    <div class="modal">
        <h3>Authentication</h3>
        <p>Enter your API token to authenticate. This token is required for all reconnaissance operations.</p>
        <input type="text" id="token-input" placeholder="API Token" spellcheck="false" autocomplete="off">
        <button class="btn" id="token-btn">Authenticate</button>
    </div>
</div>

<script>
    let TOKEN = localStorage.getItem('api_token') || '';
    let _timer = null, _start = 0;

    function setToken(t) { TOKEN = t; localStorage.setItem('api_token', t); }
    function hdrs() { return { 'Content-Type':'application/json', 'X-API-Token': TOKEN }; }

    /* Clock */
    function tick() { document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-GB'); }
    setInterval(tick, 1000); tick();

    /* Timer */
    function timerStart() {
        _start = Date.now();
        const el = document.getElementById('scan-timer');
        _timer = setInterval(() => {
            const s = Math.floor((Date.now()-_start)/1000);
            el.textContent = String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0');
        }, 250);
    }
    function timerStop() { clearInterval(_timer); return ((Date.now()-_start)/1000).toFixed(1); }

    /* Phases */
    function show(p) {
        document.getElementById('phase-input').style.display = p==='input' ? '' : 'none';
        document.getElementById('phase-scan').style.display = p==='scan' ? '' : 'none';
        document.getElementById('phase-results').style.display = p==='results' ? '' : 'none';
    }

    /* Steps */
    const stepTexts = ['Validating domain...','Resolving DNS...','Querying crt.sh (Certificate Transparency)...','Querying Wayback Machine...','Processing results...'];
    function stepTo(idx) {
        document.querySelectorAll('#steps > div').forEach((el,i) => {
            el.className = i < idx ? 'done' : i === idx ? 'active' : '';
            el.textContent = (i < idx ? '\u2713 ' : '') + stepTexts[i];
        });
    }

    /* Init */
    document.addEventListener('DOMContentLoaded', () => {
        if (!TOKEN) document.getElementById('token-overlay').classList.remove('hidden');
    });
    document.getElementById('token-btn').addEventListener('click', () => {
        const v = document.getElementById('token-input').value.trim();
        if (v) { setToken(v); document.getElementById('token-overlay').classList.add('hidden'); }
    });
    document.getElementById('token-input').addEventListener('keydown', e => {
        if (e.key === 'Enter') document.getElementById('token-btn').click();
    });
    document.getElementById('btn-new').addEventListener('click', () => {
        document.getElementById('domain').value = '';
        show('input');
    });

    /* Submit */
    document.getElementById('recon-form').addEventListener('submit', async e => {
        e.preventDefault();
        const domain = document.getElementById('domain').value.trim();
        const mods = Array.from(document.querySelectorAll('input[name="modules"]:checked')).map(el => el.value);
        if (!domain || !mods.length) return;

        /* Reset steps */
        document.querySelectorAll('#steps > div').forEach((el,i) => { el.textContent = stepTexts[i]; el.className = ''; });
        document.getElementById('scan-target').textContent = domain;
        show('scan');
        timerStart();
        stepTo(0);

        try {
            /* Validate */
            let r = await fetch('/api/validate-domain', { method:'POST', headers:hdrs(), body:JSON.stringify({domain}) });
            if (!r.ok) { const e = await r.json(); throw new Error(e.message||e.error||'Validation failed'); }
            const val = await r.json();
            stepTo(1);

            /* Recon */
            stepTo(2);
            r = await fetch('/api/reconnaissance', { method:'POST', headers:hdrs(), body:JSON.stringify({domain:val.domain, modules:mods}) });
            if (!r.ok) { const e = await r.json(); throw new Error(e.error||'Reconnaissance failed'); }
            stepTo(4);
            const data = await r.json();
            const elapsed = timerStop();
            render(data, elapsed);
            show('results');
        } catch(err) {
            const elapsed = timerStop();
            show('results');
            document.getElementById('res-title').textContent = 'ERROR';
            document.getElementById('res-meta').textContent = domain;
            document.getElementById('res-grid').innerHTML =
                '<div class="card"><div class="card-head"><span class="card-head-title">Error</span><span class="badge badge-fail">FAILED</span></div><div class="card-body"><p style="color:#888;font-size:.82rem;">' + esc(err.message) + '</p></div></div>';
        }
    });

    /* Render */
    function render(data, elapsed) {
        document.getElementById('res-title').textContent = 'RECONNAISSANCE COMPLETE';
        document.getElementById('res-meta').textContent = data.domain + '  \u2022  ' + new Date(data.timestamp).toLocaleString('en-GB') + '  \u2022  ' + elapsed + 's';
        const g = document.getElementById('res-grid');
        g.innerHTML = '';

        /* Summary card */
        let totalFindings = 0;
        const dns = data.results.dns;
        const subs = data.results.subdomains;
        const wb = data.results.wayback;
        if (dns && dns.status === 'success') totalFindings++;
        if (subs && subs.status === 'success' && subs.data) totalFindings += subs.data.length;
        if (wb && wb.status === 'success' && wb.data) totalFindings += wb.data.length;

        g.appendChild(mkCard('Summary', 'ok',
            kvBlock([
                ['Target', data.domain],
                ['Status', data.status],
                ['Duration', elapsed + ' seconds'],
                ['Total Findings', String(totalFindings)],
                ['Modules Executed', data.modules_run.join(', ')]
            ])
        ));

        /* DNS */
        if (dns) {
            g.appendChild(mkCard('DNS Resolution', dns.status === 'success' ? 'ok' : 'fail',
                dns.status === 'success'
                    ? kvBlock([['IP Address', dns.ip], ['Source', 'Direct DNS Lookup'], ['Status', 'Resolved']])
                    : '<div class="no-data">' + esc(dns.error || 'Resolution failed') + '</div>'
            ));
        }

        /* Subdomains */
        if (subs) {
            if (subs.status === 'success' && subs.data && subs.data.length > 0) {
                g.appendChild(mkCard('Subdomains \u2014 ' + subs.data.length + ' found', 'ok',
                    listBlock(subs.data) + '<div class="dlist-footer">Source: ' + esc(subs.source) + '</div>'
                ));
            } else {
                g.appendChild(mkCard('Subdomains', 'empty',
                    '<div class="no-data">No subdomains discovered via Certificate Transparency.</div>'
                ));
            }
        }

        /* Wayback */
        if (wb) {
            if (wb.status === 'success' && wb.data && wb.data.length > 0) {
                g.appendChild(mkCard('Wayback Machine \u2014 ' + wb.data.length + ' URLs', 'ok',
                    listBlock(wb.data) + '<div class="dlist-footer">Source: Wayback Machine CDX API</div>'
                ));
            } else {
                g.appendChild(mkCard('Wayback Machine', 'empty',
                    '<div class="no-data">No historical snapshots found.</div>'
                ));
            }
        }

        /* Modules requiring API keys */
        for (const [key, val] of Object.entries(data.results)) {
            if (['dns','subdomains','wayback'].includes(key)) continue;
            if (val.simulated) {
                g.appendChild(mkCard(capitalize(key), 'key',
                    '<div class="no-data">Requires API key. Configure ' + esc(key.toUpperCase()) + '_API_KEY in environment to enable.</div>'
                ));
            } else if (val.status === 'success' && val.data) {
                g.appendChild(mkCard(capitalize(key), 'ok', listBlock(val.data)));
            }
        }
    }

    /* Helpers */
    function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
    function capitalize(s) { return s.charAt(0).toUpperCase()+s.slice(1); }

    function mkCard(title, type, body) {
        const c = document.createElement('div');
        c.className = 'card';
        const bclass = type==='ok'?'badge-ok':type==='fail'?'badge-fail':type==='empty'?'badge-empty':'badge-key';
        const blabel = type==='ok'?'OK':type==='fail'?'FAIL':type==='empty'?'NO DATA':'API KEY';
        c.innerHTML = '<div class="card-head"><span class="card-head-title">'+esc(title)+'</span><span class="badge '+bclass+'">'+blabel+'</span></div><div class="card-body">'+body+'</div>';
        return c;
    }

    function listBlock(items) {
        let h = '<ul class="dlist">';
        items.forEach(item => { h += '<li>'+esc(String(item))+'</li>'; });
        return h + '</ul>';
    }

    function kvBlock(pairs) {
        let h = '';
        pairs.forEach(([k,v]) => { h += '<div class="kv"><span class="kv-k">'+esc(k)+'</span><span class="kv-v">'+esc(v)+'</span></div>'; });
        return h;
    }
</script>
</body>
</html>
